<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Amelia VRM1</title>
    <style>
        body { margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); overflow: hidden; }
        canvas { width: 100vw; height: 100vh; display: block; }
        #status { position: absolute; top: 10px; left: 10px; color: white; font-family: Arial; }
    </style>
    <!-- VRM 1.0 modules -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <div id="status">Loading...</div>
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as VRM from '@pixiv/three-vrm@2.0.9/lib/three-vrm.module.js';

        const status = document.getElementById('status');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        const camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 20);
        camera.position.set(0, 1.4, 1.2);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 1, 1);
        scene.add(light);

        let currentVrm = null;
        let isTalking = false;

        // TRY VRM1 FIRST
        const loader = new GLTFLoader();
        loader.load('./Amelia.vrm', async (gltf) => {  // LOCAL FILE
            try {
                currentVrm = await VRM.VRM.from(gltf);
                scene.add(currentVrm.scene);
                currentVrm.scene.rotation.y = Math.PI;
                status.textContent = '✅ Amelia VRM1 loaded!';
                console.log('✅ VRM1 success');
            } catch(e) {
                status.textContent = 'VRM1 failed, using 2D...';
                load2DFallback();
            }
        }, undefined, (err) => {
            status.textContent = 'VRM download failed, using 2D...';
            load2DFallback();
        });

        function load2DFallback() {
            // Your working 2D avatar code here (already functional)
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            // ... rest of 2D drawing code from previous
            const texture = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
            sprite.scale.set(1.5, 1.5, 1);
            scene.add(sprite);
            currentVrm = { expressionManager: { setValue: (name, val) => {
                if (name === 'aa') {
                    ctx.clearRect(0,0,512,512);
                    // Redraw with animated mouth
                    ctx.fillStyle = '#f4c4f3'; ctx.beginPath(); ctx.arc(256,256,200,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.fillRect(140,180,60,60); ctx.fillRect(312,180,60,60);
                    ctx.fillStyle = '#333'; ctx.fillRect(200,280,112,80 + val * 100);
                    texture.needsUpdate = true;
                }
            }}};
        }

        window.startTalking = (text) => {
            isTalking = true;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onend = () => isTalking = false;
            speechSynthesis.speak(utterance);
        };

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (currentVrm) {
                if (isTalking) {
                    currentVrm.expressionManager?.setValue('aa', Math.random() * 0.8 + 0.2);
                } else {
                    currentVrm.expressionManager?.setValue('aa', 0);
                }
                const blink = Math.max(0, Math.sin(Date.now() * 0.01) * 2 - 1.5);
                currentVrm.expressionManager?.setValue('blink', blink);
                currentVrm.update?.(0.016);
            }
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
