<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Groq VRM Chatbot</title>
    <style>
        body { margin: 0; font-family: Arial; }
        #container { display: flex; height: 100vh; }
        #scene-container { flex: 1; position: relative; }
        #chat-ui { width: 300px; background: #f0f0f0; padding: 20px; overflow-y: auto; }
        #chat { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; margin-bottom: 10px; }
        #input-container { display: flex; }
        #message { flex: 1; padding: 10px; }
        #send { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .message { margin-bottom: 10px; }
        .user { text-align: right; color: blue; }
        .bot { color: green; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.skypack.dev/three@0.169.0",
                "three/addons/": "https://cdn.skypack.dev/three@0.169.0/addons/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VRMUtils, VRM, VRMSchema } from 'https://cdn.skypack.dev/@pixiv/three-vrm@2';

        // Globals
        let scene, camera, renderer, vrm, mixer, clock;
        let currentUtterance = null;
        const messages = [{ role: 'system', content: 'You are a friendly assistant.' }];
        const GROQ_API_KEY = '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'; // Replace with your key
        const GROQ_URL = 'https://api.groq.com/openai/v1/chat/completions';

        // Viseme mapping (simple: volume to mouth open, etc.)
        const visemes = ['sil', 'a', 'i', 'u', 'e', 'o']; // VRM standard-ish
        let currentVisemeIndex = 0;

        init();
        animate();

        async function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.4, 2.5);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('scene-container').appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1.4, 0);
            controls.update();

            // Lights
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(1, 1, 1);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040, 0.4));

            clock = new THREE.Clock();

            // Load VRM
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMUtils.GltfLoaderPlugin(parser));
            const gltf = await loader.loadAsync('./avatar.vrm');
            vrm = gltf.userData.vrm;
            scene.add(vrm.scene);

            // Eye gaze setup (look at camera)
            vrm.lookAt.active = true;
            vrm.lookAt.target = camera.position; // Simple gaze

            // Chat UI
            document.getElementById('send').onclick = sendMessage;
            document.getElementById('message').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            window.addEventListener('resize', onWindowResize);
        }

        async function sendMessage() {
            const input = document.getElementById('message');
            const userMsg = input.value.trim();
            if (!userMsg) return;
            input.value = '';

            addToChat('You', userMsg, 'user');
            messages.push({ role: 'user', content: userMsg });

            const reply = await fetch(GROQ_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${GROQ_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama3-8b-8192',
                    messages,
                    temperature: 0.7,
                    stream: false
                })
            }).then(r => r.json()).then(data => data.choices[0].message.content);

            messages.push({ role: 'assistant', content: reply });
            addToChat('Bot', reply, 'bot');

            // Speak and lip-sync
            speak(reply);
        }

        function addToChat(sender, text, className) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.textContent = `${sender}: ${text}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function speak(text) {
            if (currentUtterance) speechSynthesis.cancel();
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.rate = 1;
            currentUtterance.pitch = 1;
            currentUtterance.onstart = () => startLipSync();
            currentUtterance.onend = stopLipSync;
            speechSynthesis.speak(currentUtterance);
        }

        // Simple lip-sync: analyze TTS audio volume
        let analyser, dataArray;
        function startLipSync() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Note: Direct TTS audio access limited; use fake volume simulation for demo
            // For real: Route TTS through MediaElementSourceNode if possible
            animateLipSync(); // Call in loop
        }

        function stopLipSync() {
            if (analyser) analyser.disconnect();
            setViseme(0); // Reset to sil
        }

        function setViseme(index) {
            if (!vrm) return;
            const mesh = vrm.expressionManager?.getExpression(VRMSchema.ExpressionPresetName.AA)?.mesh; // Adapt to your VRM's mouth morphs
            if (mesh) {
                mesh.morphTargetInfluences?.fill(0);
                if (index > 0) mesh.morphTargetInfluences[index - 1] = Math.min(1, index / 5);
            }
            // Eye blink/gaze during talk
            vrm.expressionManager?.setValue(VRMSchema.ExpressionPresetName.Blink, 0.2);
        }

        function updateLipSync() {
            if (!dataArray) return;
            // Simulate volume-based viseme (in real: analyser.getByteFrequencyData(dataArray); avg = dataArray.reduce... )
            const volume = Math.random() * 0.8 + 0.2; // Fake for demo; replace with real analysis
            currentVisemeIndex = Math.floor(volume * (visemes.length - 1));
            setViseme(currentVisemeIndex);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (vrm) {
                vrm.update(clock.getDelta());
                updateLipSync(); // Lip-sync loop
            }
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Helper for sendMessage Enter key
        function sendMessage() {
            document.getElementById('send').click();
        }
    </script>
</head>
<body>
    <div id="container">
        <div id="scene-container"></div>
        <div id="chat-ui">
            <div id="chat"></div>
            <div id="input-container">
                <input id="message" type="text" placeholder="Type message...">
                <button id="send">Send</button>
            </div>
        </div>
    </div>
</body>
</html>
